<div class="csv-import-dialog">
  <h2 mat-dialog-title>Import Provisions from CSV</h2>

  <mat-dialog-content>
    <div class="upload-section">
      <mat-form-field appearance="outline">
        <mat-label>Select CSV file</mat-label>
        <input matInput [value]="" placeholder="Choose a .csv file" readonly>
        <button mat-button matSuffix (click)="fileInput.click()">Browse</button>
        <input type="file" #fileInput accept=".csv" (change)="onFileChange($event)" hidden>
      </mat-form-field>

      <div class="template-actions">
        <button mat-stroked-button (click)="downloadTemplate('minimal')">Download Minimal Template</button>
        <button mat-stroked-button (click)="downloadTemplate('full')">Download Full Template</button>
      </div>

      <div class="progress" *ngIf="parsing || uploading">
        <mat-spinner diameter="32"></mat-spinner>
        <span>{{ parsing ? 'Parsing CSV...' : 'Uploading...' }}</span>
      </div>

      <div class="errors" *ngIf="errors.length">
        <h4>Errors</h4>
        <ul>
          <li *ngFor="let e of errors">{{e}}</li>
        </ul>
      </div>
    </div>

    <div *ngIf="headers.length" class="mapping-section">
      <h3>Column Mapping</h3>
      <table mat-table [dataSource]="headers" class="mapping-table">
        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef>CSV Header</th>
          <td mat-cell *matCellDef="let h">{{h}}</td>
        </ng-container>
        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>Map to Field</th>
          <td mat-cell *matCellDef="let h">
            <mat-form-field appearance="fill" class="map-field">
              <mat-select [value]="mapping[h]" (selectionChange)="setMapping(h, $event.value)">
                <mat-option [value]="''">-- Ignore --</mat-option>
                <mat-option *ngFor="let f of backendFields" [value]="f">{{f}}</mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="['source','target']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['source','target']"></tr>
      </table>
    </div>

    <div *ngIf="parsedRows.length" class="preview-section">
      <h3>Preview (first 5 rows)</h3>
      <table mat-table [dataSource]="parsedRows.slice(0,5)" class="preview-table">
        <ng-container *ngFor="let col of previewColumns" [matColumnDef]="col">
          <th mat-header-cell *matHeaderCellDef>{{col}}</th>
          <td mat-cell *matCellDef="let row">{{row[col]}}</td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="previewColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: previewColumns"></tr>
      </table>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">Cancel</button>
    <button mat-raised-button color="primary" (click)="import()" [disabled]="!parsedRows.length || uploading">Import</button>
  </mat-dialog-actions>
</div>
